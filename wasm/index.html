<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Butabuti WASM - Embroidery File Converter</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                background: white;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                overflow: hidden;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .header p {
                font-size: 1.1em;
                opacity: 0.9;
            }

            .header .badge {
                display: inline-block;
                background: rgba(255, 255, 255, 0.2);
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.9em;
                margin-top: 10px;
            }

            .content {
                padding: 40px;
            }

            .card {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 25px;
                margin-bottom: 25px;
            }

            .card h2 {
                color: #667eea;
                margin-bottom: 20px;
                font-size: 1.5em;
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: #333;
            }

            input[type="file"] {
                display: block;
                width: 100%;
                padding: 12px;
                border: 2px dashed #667eea;
                border-radius: 6px;
                background: white;
                cursor: pointer;
                transition: all 0.3s;
            }

            input[type="file"]:hover {
                border-color: #764ba2;
                background: #f8f9fa;
            }

            select {
                width: 100%;
                padding: 12px;
                border: 2px solid #e0e0e0;
                border-radius: 6px;
                font-size: 1em;
                background: white;
                cursor: pointer;
                transition: border-color 0.3s;
            }

            select:focus {
                outline: none;
                border-color: #667eea;
            }

            button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 14px 32px;
                font-size: 1.1em;
                font-weight: 600;
                border-radius: 6px;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
                display: inline-block;
                margin-right: 10px;
                margin-bottom: 10px;
            }

            button:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            button:active:not(:disabled) {
                transform: translateY(0);
            }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            #output {
                margin-top: 30px;
                padding: 20px;
                background: white;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
            }

            #output.success {
                border-color: #4caf50;
                background: #f1f8f4;
            }

            #output.error {
                border-color: #f44336;
                background: #fef1f0;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-top: 20px;
            }

            .stat-item {
                background: white;
                padding: 15px;
                border-radius: 6px;
                border-left: 4px solid #667eea;
            }

            .stat-label {
                font-size: 0.9em;
                color: #666;
                margin-bottom: 5px;
            }

            .stat-value {
                font-size: 1.5em;
                font-weight: 600;
                color: #333;
            }

            .color-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }

            .color-chip {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 12px;
                background: white;
                border-radius: 6px;
                border: 1px solid #e0e0e0;
            }

            .color-swatch {
                width: 30px;
                height: 30px;
                border-radius: 4px;
                border: 2px solid #e0e0e0;
            }

            #svgPreview {
                width: 100%;
                max-width: 100%;
                max-height: 600px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                background: white;
                margin-top: 20px;
                overflow: auto;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #svgPreview svg {
                max-width: 100%;
                max-height: 580px;
                height: auto;
            }

            .loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .hidden {
                display: none;
            }

            code {
                background: #f4f4f4;
                padding: 2px 6px;
                border-radius: 3px;
                font-family: "Courier New", monospace;
            }

            pre {
                background: #f4f4f4;
                padding: 15px;
                border-radius: 6px;
                overflow-x: auto;
                margin-top: 10px;
            }

            .file-info {
                background: white;
                padding: 15px;
                border-radius: 6px;
                margin-top: 15px;
                border: 1px solid #e0e0e0;
            }

            .file-info strong {
                color: #667eea;
            }

            .alert {
                padding: 15px;
                border-radius: 6px;
                margin-bottom: 20px;
            }

            .alert-info {
                background: #e3f2fd;
                border: 1px solid #2196f3;
                color: #0d47a1;
            }

            .alert-warning {
                background: #fff3e0;
                border: 1px solid #ff9800;
                color: #e65100;
            }

            .button-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 1.8em;
                }

                .content {
                    padding: 20px;
                }

                .button-group {
                    flex-direction: column;
                }

                button {
                    width: 100%;
                    margin-right: 0;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üé® Butabuti WASM</h1>
                <p>
                    Convert embroidery files directly in your browser - no
                    server required!
                </p>
                <div class="badge">‚ú® Privacy-First ‚Ä¢ üöÄ Fast ‚Ä¢ üîí Secure</div>
            </div>

            <div class="content">
                <div class="alert alert-info">
                    <strong>üîí Your Privacy Matters:</strong> All file
                    processing happens entirely in your browser. Your files
                    never leave your computer and are not uploaded to any
                    server.
                </div>

                <!-- File Upload Section -->
                <div class="card">
                    <h2>üìÅ Upload Embroidery File</h2>
                    <div class="form-group">
                        <label for="fileInput"
                            >Choose an embroidery file (DST, PES, JEF, EXP, VP3,
                            etc.)</label
                        >
                        <input type="file" id="fileInput" accept="" />
                    </div>

                    <div id="fileInfo" class="file-info hidden"></div>

                    <div class="form-group">
                        <label for="outputFormat">Convert to format:</label>
                        <select id="outputFormat">
                            <option value="">-- Select format --</option>
                            <!-- Formats populated programmatically from FormatRegistry -->
                        </select>
                    </div>

                    <div class="button-group">
                        <button id="convertBtn" disabled>
                            üîÑ Convert File
                        </button>
                        <button id="infoBtn" disabled>
                            üìä Get Pattern Info
                        </button>
                        <button id="previewBtn" disabled>üñºÔ∏è Preview SVG</button>
                    </div>
                </div>

                <!-- Output Section -->
                <div id="output" class="hidden"></div>
            </div>
        </div>

        <script type="module">
            // Import WASM module
            import init, {
                convert_pattern,
                get_pattern_info,
                export_to_svg,
                list_formats,
            } from "./pkg/butabuti.js";

            let wasmReady = false;
            let fileData = null;
            let fileFormat = null;
            let fileName = "";

            // Initialize WASM
            async function initWasm() {
                try {
                    await init();
                    wasmReady = true;
                    console.log("‚úÖ WASM module loaded successfully");

                    // Load and populate formats programmatically
                    const formats = JSON.parse(list_formats());
                    console.log("Supported formats:", formats);

                    populateFormatSelect(formats);
                    updateFileAcceptTypes(formats);
                } catch (err) {
                    showError("Failed to load WASM module: " + err.message);
                    console.error(err);
                }
            }

            // Programmatically populate format dropdown
            function populateFormatSelect(formats) {
                const select = document.getElementById("outputFormat");

                // Clear existing options (except first)
                select.innerHTML =
                    '<option value="">-- Select format --</option>';

                // Group formats
                const embroideryFormats = formats.output_formats.filter(
                    (f) => !["svg", "txt", "csv", "json"].includes(f.name)
                );
                const exportFormats = formats.output_formats.filter((f) =>
                    ["svg", "txt", "csv", "json"].includes(f.name)
                );

                // Add embroidery formats group
                if (embroideryFormats.length > 0) {
                    const embGroup = document.createElement("optgroup");
                    embGroup.label = "Embroidery Formats";
                    embroideryFormats.forEach((fmt) => {
                        const option = document.createElement("option");
                        option.value = fmt.name;
                        option.textContent = `${
                            fmt.display_name
                        } - ${fmt.description.replace(
                            / format$| embroidery data$| color format$/i,
                            ""
                        )}`;
                        embGroup.appendChild(option);
                    });
                    select.appendChild(embGroup);
                }

                // Add export formats group
                if (exportFormats.length > 0) {
                    const expGroup = document.createElement("optgroup");
                    expGroup.label = "Export Formats";
                    exportFormats.forEach((fmt) => {
                        const option = document.createElement("option");
                        option.value = fmt.name;
                        option.textContent = `${
                            fmt.display_name
                        } - ${fmt.description.replace(
                            / format$| embroidery data$/i,
                            ""
                        )}`;
                        if (fmt.name === "svg") option.selected = true;
                        expGroup.appendChild(option);
                    });
                    select.appendChild(expGroup);
                }
            }

            // Update file input accept attribute programmatically
            function updateFileAcceptTypes(formats) {
                const fileInput = document.getElementById("fileInput");
                const extensions = formats.input_formats.flatMap(
                    (f) => f.extensions
                );
                fileInput.accept = extensions.map((ext) => "." + ext).join(",");
            }

            // File input handler
            document
                .getElementById("fileInput")
                .addEventListener("change", async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    fileName = file.name;

                    // Detect format from extension
                    const ext = file.name.split(".").pop().toLowerCase();
                    fileFormat = ext;

                    // Read file as array buffer
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        fileData = new Uint8Array(e.target.result);

                        // Enable buttons
                        document.getElementById("convertBtn").disabled = false;
                        document.getElementById("infoBtn").disabled = false;
                        document.getElementById("previewBtn").disabled = false;

                        // Show file info
                        const fileInfo = document.getElementById("fileInfo");
                        fileInfo.classList.remove("hidden");
                        fileInfo.innerHTML = `
                            <strong>üìÑ File:</strong> ${file.name}<br>
                            <strong>üìè Size:</strong> ${formatBytes(
                                fileData.length
                            )}<br>
                            <strong>üè∑Ô∏è Format:</strong> ${ext.toUpperCase()}
                        `;

                        showSuccess(
                            `‚úÖ File loaded successfully! Ready to convert.`
                        );
                    };
                    reader.readAsArrayBuffer(file);
                });

            // Convert button handler
            document
                .getElementById("convertBtn")
                .addEventListener("click", async () => {
                    if (!wasmReady || !fileData) return;

                    const outputFormat =
                        document.getElementById("outputFormat").value;
                    if (!outputFormat) {
                        showError("Please select an output format");
                        return;
                    }

                    try {
                        showLoading("Converting file...");

                        const result = convert_pattern(
                            fileData,
                            fileFormat,
                            outputFormat
                        );

                        // Create download link
                        const blob = new Blob([result], {
                            type: "application/octet-stream",
                        });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;

                        // Use original filename with new extension
                        const baseName = fileName.substring(
                            0,
                            fileName.lastIndexOf(".")
                        );
                        a.download = `${baseName}.${outputFormat}`;
                        a.click();
                        URL.revokeObjectURL(url);

                        showSuccess(
                            `‚úÖ Conversion complete!<br><br>` +
                                `<strong>Downloaded:</strong> ${a.download}<br>` +
                                `<strong>Size:</strong> ${formatBytes(
                                    result.length
                                )}<br>` +
                                `<strong>Format:</strong> ${outputFormat.toUpperCase()}`
                        );
                    } catch (err) {
                        showError(
                            "Conversion failed: " +
                                err +
                                "<br><br>" +
                                "Please check that the file format is correct."
                        );
                    }
                });

            // Info button handler
            document
                .getElementById("infoBtn")
                .addEventListener("click", async () => {
                    if (!wasmReady || !fileData) return;

                    try {
                        showLoading("Analyzing pattern...");

                        const info = JSON.parse(
                            get_pattern_info(fileData, fileFormat)
                        );

                        let html = "<h3>üìä Pattern Statistics</h3>";
                        html += '<div class="stats-grid">';
                        html += `<div class="stat-item"><div class="stat-label">Stitches</div><div class="stat-value">${info.stitch_count.toLocaleString()}</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Colors</div><div class="stat-value">${info.color_count}</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Color Changes</div><div class="stat-value">${info.color_changes}</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Jumps</div><div class="stat-value">${info.jumps}</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Trims</div><div class="stat-value">${info.trims}</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Width</div><div class="stat-value">${info.width_mm.toFixed(
                            1
                        )} mm</div></div>`;
                        html += `<div class="stat-item"><div class="stat-label">Height</div><div class="stat-value">${info.height_mm.toFixed(
                            1
                        )} mm</div></div>`;
                        html += "</div>";

                        // Color list
                        if (info.colors && info.colors.length > 0) {
                            html +=
                                '<h4 style="margin-top: 25px; margin-bottom: 10px;">üé® Thread Colors</h4>';
                            html += '<div class="color-list">';
                            info.colors.forEach((color, idx) => {
                                const rgb = `rgb(${color.red}, ${color.green}, ${color.blue})`;
                                html += `<div class="color-chip">`;
                                html += `<div class="color-swatch" style="background-color: ${rgb}"></div>`;
                                html += `<span><strong>${idx + 1}.</strong> ${
                                    color.description
                                }</span>`;
                                html += `</div>`;
                            });
                            html += "</div>";
                        }

                        // Raw JSON (collapsible)
                        html +=
                            '<details style="margin-top: 25px;"><summary style="cursor: pointer; font-weight: 600; padding: 10px; background: #f4f4f4; border-radius: 6px;">üîç View Raw Data (JSON)</summary>';
                        html += `<pre>${JSON.stringify(info, null, 2)}</pre>`;
                        html += "</details>";

                        showSuccess(html);
                    } catch (err) {
                        showError(
                            "Failed to get pattern info: " +
                                err +
                                "<br><br>" +
                                "Please check that the file format is correct."
                        );
                    }
                });

            // Preview button handler
            document
                .getElementById("previewBtn")
                .addEventListener("click", async () => {
                    if (!wasmReady || !fileData) return;

                    try {
                        showLoading("Generating SVG preview...");

                        const svg = export_to_svg(fileData, fileFormat);

                        let html = "<h3>üñºÔ∏è SVG Preview</h3>";
                        html += `<div id="svgPreview">${svg}</div>`;
                        html +=
                            '<p style="margin-top: 15px; color: #666;"><em>Tip: Right-click on the preview and select "Save Image As" to save as SVG file.</em></p>';

                        showSuccess(html);
                    } catch (err) {
                        showError(
                            "Failed to generate preview: " +
                                err +
                                "<br><br>" +
                                "Please check that the file format is correct."
                        );
                    }
                });

            // Helper functions
            function formatBytes(bytes) {
                if (bytes === 0) return "0 Bytes";
                const k = 1024;
                const sizes = ["Bytes", "KB", "MB", "GB"];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return (
                    Math.round((bytes / Math.pow(k, i)) * 100) / 100 +
                    " " +
                    sizes[i]
                );
            }

            function showLoading(message) {
                const output = document.getElementById("output");
                output.className = "";
                output.classList.remove("hidden", "error", "success");
                output.innerHTML = `<div style="text-align: center;"><div class="loading"></div> ${message}</div>`;
            }

            function showSuccess(html) {
                const output = document.getElementById("output");
                output.className = "success";
                output.classList.remove("hidden");
                output.innerHTML = html;
                output.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }

            function showError(message) {
                const output = document.getElementById("output");
                output.className = "error";
                output.classList.remove("hidden");
                output.innerHTML = `<strong>‚ùå Error:</strong> ${message}`;
                output.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }

            // Initialize on page load
            initWasm();
        </script>
    </body>
</html>
